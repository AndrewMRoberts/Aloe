<html>
    <head>
        <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
        <link type="text/css" rel="stylesheet" href="css/materialize.min.css"  media="screen,projection"/>
        <link type="text/css" rel="stylesheet" href="css/app.css"/>
    </head>

    <body>
        <nav>
            <div class="nav-wrapper">
                <a href="#" data-target="slide-out" class="sidenav-trigger"><i class="material-icons">menu</i></a>
                <a href="#" class="brand-logo">Aloe</a>
                <ul id="nav-mobile" class="right hide-on-med-and-down">
                    <li><a>Sass</a></li>
                    <li><a>Components</a></li>
                    <li><a>JavaScript</a></li>
                </ul>
            </div>
        </nav>

        <ul id="slide-out" class="sidenav">
            <li><a>Sass</a></li>
            <li><a>Components</a></li>
            <li><a>JavaScript</a></li>
        </ul>

        <div class='row'>
            <div class='col s12'>
                <div class='card'>
                    <div class='card-content'>
                        <div class='row'>
                            <div class='col s4'>
                                <span class='card-title'>Loans</span>
                            </div>
                            <div class='col s4'>
                                <a class='waves-effect waves-light-btn btn' id='test-save-data-button'>Save Data</a>
                            </div>
                            <div class='col s4'>
                                <a class='waves-effect waves-light-btn btn modal-trigger' data-target='add-loan-modal'>Add Loan</a></span>
                            </div>
                        </div>
                        
                        <canvas id="loan-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        
        <div id="add-loan-modal" class="modal">
            <div class="modal-content">
                <h4>Add New Loan</h4>
                <div class='row'>
                    <div class='col-12 input-field'>
                        <input placeholder='Name' id='loan-name' type='text'/>
                    </div>
                </div>
                <div class='row'>
                    <div class='col s6 input-field'>
                        <input placeholder='Amount' id='loan-amount' type='number'/>
                    </div>
                    <div class='col s6 input-field'>
                        <input placeholder='Rate' id='loan-rate' type='number'/>
                    </div>
                </div>
                <div class='row'>
                    <div class='col s6 input-field'>
                        <input placeholder='Monthly Payment' id='loan-payment' type='number'/>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a href="#!" id='loan-save-button' class="modal-close waves-effect waves-green btn">Save</a>
            </div>
        </div>
    </body>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0/dist/Chart.min.js"></script>
    <script type="text/javascript" src="js/materialize.min.js"></script>

    <script>
        // Initialize materialize scripts
        $('.sidenav').sidenav();
        $('.modal').modal();
        var monthlyPayment = 250;

        getLoanData(function(data) {
            var ctx = $('#loan-chart')[0].getContext('2d');
            var config = {
                type: 'line',
                data: data,
                options: {
                    title: {
                        display: true,
                        text: 'Muh Loans'
                    },
                    scales: {
                        yAxes: [{
                            stacked: true
                        }]
                    }
                }
            };
            var myChart = new Chart(ctx, config);
        });

        $('#test-save-data-button').click(saveLoanData);
        $('#loan-save-button').click(function() {
            var amount = parseFloat($('#loan-amount').val());
            var rate = parseFloat($("#loan-rate").val());

            var newDataset = [amount];
            var goingToZeroAmount = amount;
            while (amount > 0) {
                amount = (amount * rate) + amount;
                if (amount - monthlyPayment < 0) {
                    amount = 0;
                } else {
                    amount -= monthlyPayment;
                }
                if (amount >= goingToZeroAmount) {
                    alert('This loan will never go to zero, abort');
                    break;
                }
                newDataset.push(amount);
            }

            getLoanData(function(data) {
                data.datasets.push({
                    label: $('#loan-name').val(),
                    data: newDataset
                })
                saveLoanData(data);

                config.data = data;
                myChart.update(config);
            });
        });

        function getLoanData(callback) {
            $.get('https://localhost:44372/api/loan/', function(response) {
                console.log(response);
                if (callback) callback(response);
            });
        }

        function saveLoanData(dataOverride) {
            getLoanData(function(data) {
                if (dataOverride) data = dataOverride;

                var maxLength = -1;
                var datasets = data.datasets;
                $.each(datasets, function(index, dataset) {
                    var length = dataset.data.length;
                    if (length > maxLength) {
                        maxLength = length;
                    }
                });

                var labels = [];
                for (var i = 1; i <= maxLength; i++) {
                    labels.push(i);
                }

                data.labels = labels;

                var dataString = JSON.stringify(data);
                window.localStorage.setItem('loanData', dataString)
            });
        }
    </script>
</html>