<!DOCTYPE html>
<html lang='en'>
  
<head>
    <meta charset='utf-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1, shrink-to-fit=no'>

    <title>Overview</title>

    <link rel='stylesheet' href='https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css'>
    <link rel='stylesheet' href='../Styles/app.css'>
  </head>

  <body>
    <nav class='navbar navbar-toggleable-md navbar-light bg-faded'>
        <button class='navbar-toggler navbar-toggler-right' type='button' data-toggle='collapse' data-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <a class='navbar-brand' href='#'>
            <!-- Include img here -->
            Aloe
        </a>
        <div class='collapse navbar-collapse' id='navbar'>
            <div class='navbar-nav'>
                <a class='nav-item nav-link' href='overview.html'>Home</a>
                <a class='nav-item nav-link' href='settings.html'>Settings</a>
                <a class='nav-item nav-link active' href='#'>Transactions</a>
            </div>
        </div>
    </nav>  

    <div class='container'>
        <h1>Transactions</h1>

        <div class='row'>
            <div class='col-6'>
                <button id='add-transaction-modal-button' class='btn btn-primary' type='button'>
                    Add Transaction
                </button>
            </div>
            <div class='col-6'>
                <button id='upload-modal-button' class='btn btn-primary' type='button'>
                    Upload Transactions
                </button>
            </div>
        </div>

        <table class='table table-striped table-hover table-responsive transaction-table' style="padding: 30px 0px">
            <thead>
                <tr>
                    <th>Description</th>
                    <th>Amount</th>
                    <th>Category</th>
                    <th>Account</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody class='transactions'>
            </tbody>
        </table>

        <div class='modal fade'>
            <div class='modal-dialog' role='document'>
                <div class='modal-content'>
                    <div class='modal-header'>
                        <h5 class='modal-title'>Upload Transactions</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class='modal-body'>
                        <form method='POST' id='upload-transaction-form' enctype='multipart/form-data'> 
                            <div id='first-page'>
                                <div class='form-group'>
                                    <label for='account-dropdown'>Select Account</label>
                                    <select class='form-control' id='account-dropdown'>
                                    </select>
                                </div>
                                <div class='form-group'>
                                    <label for='upload-file'>Transaction File</label>
                                    <input type='file' class='form-control-file' id='upload-file'>
                                    <p class='error' id='file-error'></p>
                                </div>
                                <div class='form-group'>
                                    <input class='form-check-input' type='checkbox' value='' id='has-header-row' style='margin-left:0px; margin-top:0.3rem;'>
                                    <label class='form-check-label' for='hasHeaderRow'>
                                        File Has Headers On First Row
                                    </label>
                                </div>
                            </div>

                            <div id='second-page'>
                                <p id='select-amount'>Please select the column containing the <b>Amount</b>.</p>
                                <p id='select-date'>Please select the column containing the <b>Transaction Date</b>.</p>
                                <p id='select-description'>Please select the column containing the <b>Transaction Description</b>.</p>

                                <div class='form-group'>
                                    <div class='table-responsive'>
                                        <table class='table table-striped table-hover'>
                                            <thead id='transaction-preview-table-header'>
                                            </thead>
                                            <tbody id='transaction-preview-table'>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" id="next-button">Next</button>
                        <button type="button" class="btn btn-primary" id="back-button">Back</button>
                        <button type="button" class="btn btn-primary" id="upload-button">Upload</button>
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script type='text/javascript'>window.$ = window.jQuery = require('jquery');</script>
    <script src='https://code.jquery.com/jquery-3.1.1.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js'></script>
    <script src='https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js'></script>
    <script type='text/javascript' src='../Scripts/helpers.js'></script>

    <script type='text/javascript'>
        $('#upload-modal-button').click(function() {
            var selectedCols = {
                amount: -1,
                date: -1,
                description: -1
            };

            $('.modal').modal();
            displayFirstUploadPage();

            $('#upload-file').change(function() {
                $('#file-error').text('');
                $('#transaction-preview-table').empty();

                if ($(this)[0].files[0]) {
                    
                    $.ajax({
                        type: 'POST',
                        url: 'http://localhost:5000/api/transaction/previewFileHeaderRow',
                        data: {
                            'filePath': $(this)[0].files[0].path
                        },
                        success: function(columns) {
                            var cols = columns[0];
                            selectedCols = {
                                amount: -1,
                                date: -1,
                                description: -1
                            };

                            if ($('.header-row').length === 0) {
                                $('#transaction-preview-table-header').append('<tr class="header-row">');
                                $.each(cols, function(i, col) {
                                    $('#transaction-preview-table-header tr.header-row').append('<th class="header-col-' + i + '"></th>');
                                });
                            }
                            
                            if ($('#transaction-preview-table .row').length === 0) {
                                $.each(columns, function(index, cols) {
                                    $('#transaction-preview-table').append('<tr class="row-' + index + '">');
                                    $.each(cols, function(i, col) {
                                        $('#transaction-preview-table tr.row-' + index).append('<td class="col-' + i + '">' + col + '</td>')
                                    });
                                    $('#transaction-preview-table').append('</tr>');
                                });

                                $('#transaction-preview-table td').on('mouseover', function() {
                                    $('.' + $(this).attr('class')).addClass('col-hover');
                                }).on('mouseout', function() {
                                    $('#transaction-preview-table td').removeClass('col-hover');  
                                }).click(function() {
                                    var index = $(this).index();

                                    var allOptions = $('#select-amount, #select-date, #select-description');
                                    var currentOption = allOptions.filter(':visible');
                                    var currentOptionId = currentOption.attr('id');

                                    switch (currentOptionId) {
                                        case 'select-amount':
                                            selectedCols.amount = index;
                                            $('#transaction-preview-table-header th.header-col-' + index).text('Amount');
                                            $('#select-amount').hide();
                                            $('#select-date').show();
                                            break;
                                        case 'select-date':
                                            selectedCols.date = index;
                                            $('#transaction-preview-table-header th.header-col-' + index).text('Date');
                                            $('#select-date').hide();
                                            $('#select-description').show();
                                            break;
                                        case 'select-description':
                                            selectedCols.description = index;
                                            $('#transaction-preview-table-header th.header-col-' + index).text('Description');
                                            $('#upload-button').prop('disabled', false);
                                            break;
                                    }
                                });
                            } else {
                                $.each(columns, function(index, cols) {
                                    $.each(cols, function(i, col) {
                                        $('#transaction-preview-table tr.row-' + index + ' .col-' + i).text(col);
                                    });
                                });

                            }
                        },
                        error: function(error) {
                            console.log('error');
                            var errorObj = JSON.parse(error.responseText);

                            // Show the error
                            $('#file-error').text(errorObj.message);
                        }
                    });

                }
            });

            $('#next-button').click(function() {
                if ($('#upload-file')[0].files[0]) {
                    $('#file-error').text('');
                    displaySecondUploadPage();
                } else {
                    $('#file-error').text("A Transaction File is Required");
                }
            });

            $('#back-button').click(function() {
                displayFirstUploadPage();
            });

            $('#upload-button').click(function() {
                $('#upload-transaction-form').submit();
            });
            $('#upload-transaction-form').submit(function(e) {
                e.preventDefault();

                $.ajax({
                    type: 'POST',
                    url: 'http://localhost:5000/api/transaction/uploadTransactions',
                    data: {
                        'filePath': $('#upload-file')[0].files[0].path,
                        'account': $('#account-dropdown :selected').val(),
                        'hasHeaderRow': $('#has-header-row').is(':checked'),
                        'selectedCols': selectedCols
                    },
                    success: function() {
                        $('.modal').modal('hide');
                        populateTransactions();
                    }, 
                    error: function(e) {
                        console.log(e);
                    }
                });
            });

            $.get('http://localhost:5000/api/account', function(accounts) {
                $(accounts).each(function(index, account) {
                    $('#account-dropdown').append(
                        '<option value=' + account.Id + '>' + account.Name + '</option>'
                    );
                });
            }); 
        });

        populateTransactions();

        function populateTransactions(callback) {
            $.get('http://localhost:5000/api/transaction', function(transactions) {
                $('.transactions').empty();
                $(transactions).each(function(index, transaction) {
                    var transactionDate = new Date(Date.parse(transaction.TransactionDate));

                    $('.transactions').append(
                        "<tr> \
                            <td>" + transaction.Description + "</td> \
                            <td class='currency-format'>$" + transaction.Amount.format(2) + "</td> \
                            <td>" + transaction.CategoryId + "</td> \
                            <td>" + transaction.AccountId + "</td> \
                            <td>" + (transactionDate.getMonth() + 1) + "/" + transactionDate.getDate() + "/" + transactionDate.getFullYear() + "</td> \
                        </tr>"
                    );
                });
                if (callback) callback();
            });
        }

        function displayFirstUploadPage() {
            $('#back-button').hide();
            $('#upload-button').hide();

            $('#transaction-preview-table-header th').text('');

            $('#second-page').fadeOut(250, function() {
                $('#first-page').fadeIn(500);
                $('#next-button').show();
            });
        }

        function displaySecondUploadPage() {
            $('#next-button').hide();
            $('#select-amount').show();
            $('#select-date').hide();
            $('#select-description').hide();
            

            $('#first-page').fadeOut(250, function() {
                $('#back-button').show();
                $('#upload-button').show();
                $('#upload-button').prop('disabled', true);
                $('#second-page').fadeIn(500);
            });
        }
    </script>
    <style>
        #transaction-preview-table td {
            cursor: pointer;
        }
    </style>
</body>

</html>